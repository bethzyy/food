# 故障排查指南

## 问题：环境变量已设置，但还是让输入API Key

### 可能原因1：使用了错误的服务器

**症状**：
- 设置了环境变量
- 启动应用后仍然提示输入API Key
- 浏览器控制台显示404错误：`GET /api/env-api-key 404`

**原因**：使用了 `start_server.py` 而不是 `server_with_env.py`

**解决方法**：

1. **检查当前运行的服务器**
   ```bash
   # 查看命令行窗口显示的信息
   # 如果只显示 "Serving HTTP on :: port 8000"，说明用的是 start_server.py（错误）
   # 如果显示 "[OK] 检测到 ZHIPU_API_KEY 环境变量"，说明用的是 server_with_env.py（正确）
   ```

2. **使用正确的启动方式**

   **方式A：使用启动脚本（推荐）**
   ```bash
   双击：启动.bat
   ```
   脚本会自动检测环境变量并选择正确的服务器

   **方式B：手动启动（确保使用正确的服务器）**
   ```bash
   # 停止当前服务器（按 Ctrl+C）

   # 使用正确的服务器
   python server_with_env.py
   ```

3. **验证**
   - 启动后应该看到：`[OK] 检测到 ZHIPU_API_KEY 环境变量`
   - 浏览器控制台应该显示：`✅ 从环境变量成功读取API Key`

### 可能原因2：环境变量在错误的窗口设置

**症状**：
- 在一个命令行窗口设置了环境变量
- 在另一个窗口启动应用

**原因**：环境变量只在当前命令行窗口有效

**解决方法**：
```bash
# 1. 打开新的命令行窗口

# 2. 在新窗口中设置环境变量
$env:ZHIPU_API_KEY="your-api-key-here"

# 3. 在同一窗口中启动应用
python server_with_env.py

# 或使用启动脚本
启动.bat
```

### 可能原因3：前端请求时序问题

**症状**：
- 服务器正常运行
- API接口可以访问
- 但前端仍然提示输入

**解决方法**：
1. 打开浏览器控制台（F12）
2. 查看 Network 标签
3. 点击"生成饮食推荐"
4. 检查 `/api/env-api-key` 请求的响应

**期望结果**：
```json
{
  "apiKey": "你的完整API Key"
}
```

**如果是404**：说明使用了错误的服务器
**如果是200但返回error**：说明环境变量未设置

### 快速诊断流程

**步骤1：测试环境变量**
```bash
# 运行测试服务器
python test_env_key.py

# 访问测试页面
# 浏览器打开：http://localhost:8001/test_env.html

# 点击"测试环境变量API"按钮
```

**期望结果**：看到 `✅ 成功从环境变量读取API Key`

**步骤2：检查主服务器**
```bash
# 停止所有正在运行的服务器（Ctrl+C）

# 使用启动脚本
双击：启动.bat

# 或手动启动
python server_with_env.py
```

**期望结果**：看到 `[OK] 检测到 ZHIPU_API_KEY 环境变量`

**步骤3：验证前端**
1. 打开浏览器控制台（F12）
2. 点击"生成饮食推荐"
3. 查看Console标签

**期望结果**：
```
✅ 从环境变量成功读取API Key
```

### 服务器对比

| 特性 | start_server.py | server_with_env.py |
|------|----------------|-------------------|
| 环境变量支持 | ❌ 否 | ✅ 是 |
| API端点 | ❌ 无 | ✅ /api/env-api-key |
| 手动输入 | ✅ 支持 | ✅ 支持 |
| 适用场景 | 测试/简单使用 | 生产环境 |

### 正确的启动方式总结

**最简单（推荐）**：
```bash
双击：启动.bat
```

**手动（确保正确）**：
```bash
# 1. 设置环境变量（可选）
$env:ZHIPU_API_KEY="your-key"

# 2. 启动正确的服务器
python server_with_env.py

# 3. 浏览器访问
http://localhost:8000
```

### 常见错误

❌ **错误1**：
```bash
python start_server.py  # 不支持环境变量
```

✅ **正确**：
```bash
python server_with_env.py  # 支持环境变量
```

❌ **错误2**：
```bash
# 窗口A设置环境变量
$env:ZHIPU_API_KEY="key"

# 窗口B启动应用  # ❌ 窗口B没有环境变量
python server_with_env.py
```

✅ **正确**：
```bash
# 同一窗口设置并启动
$env:ZHIPU_API_KEY="key"
python server_with_env.py
```

### 终极解决方案

如果以上都不行，创建一个启动脚本：

```batch
@echo off
echo 设置环境变量...
set ZHIPU_API_KEY=your-actual-api-key-here

echo 启动服务器...
python server_with_env.py

pause
```

保存为 `我的启动.bat`，每次双击运行即可。

---

**如果问题仍未解决，请提供以下信息**：
1. 命令行窗口显示的完整启动信息
2. 浏览器控制台的错误信息（F12 → Console）
3. 浏览器Network标签中 `/api/env-api-key` 的响应
