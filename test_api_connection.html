<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>APIè¿æ¥æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #42a5f5;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1976d2;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
        .success {
            background: #c8e6c9;
            color: #2e7d32;
        }
        .error {
            background: #ffcdd2;
            color: #c62828;
        }
        .info {
            background: #bbdefb;
            color: #1565c0;
        }
    </style>
</head>
<body>
    <h1>ğŸ” APIè¿æ¥è¯Šæ–­å·¥å…·</h1>

    <div class="test-section">
        <h3>1. æ£€æŸ¥ç¯å¢ƒå˜é‡API Key</h3>
        <button onclick="testEnvAPIKey()">æµ‹è¯•ç¯å¢ƒå˜é‡API Key</button>
        <div id="envResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>2. æ£€æŸ¥localStorage API Key</h3>
        <button onclick="testLocalStorageAPIKey()">æµ‹è¯•æœ¬åœ°å­˜å‚¨API Key</button>
        <div id="localResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>3. æµ‹è¯•æ™ºè°±AI APIè¿æ¥ (GLM-4-flash)</h3>
        <button onclick="testGLMAPI()">æµ‹è¯•APIè°ƒç”¨</button>
        <div id="apiResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>4. ç½‘ç»œè¿æ¥æµ‹è¯•</h3>
        <button onclick="testNetworkConnectivity()">æµ‹è¯•ç½‘ç»œè¿æ¥</button>
        <div id="networkResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>5. æµè§ˆå™¨ä¿¡æ¯</h3>
        <button onclick="showBrowserInfo()">æ˜¾ç¤ºæµè§ˆå™¨ä¿¡æ¯</button>
        <div id="browserResult" class="result"></div>
    </div>

    <script>
        const API_ENDPOINT = 'https://open.bigmodel.cn/api/anthropic/v1/messages';

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.textContent = message;
            console.log(`[${elementId}]`, message);
        }

        async function testEnvAPIKey() {
            log('envResult', 'æ­£åœ¨æµ‹è¯•ç¯å¢ƒå˜é‡API Key...', 'info');

            try {
                const response = await fetch('/api/env-api-key');
                const data = await response.json();

                if (data.apiKey) {
                    const maskedKey = data.apiKey.substring(0, 10) + '...' + data.apiKey.substring(data.apiKey.length - 4);
                    log('envResult', `âœ… æˆåŠŸ! ç¯å¢ƒå˜é‡API Key: ${maskedKey}\næ ¼å¼æ­£ç¡®: ${data.apiKey.includes('.')}`, 'success');
                } else {
                    log('envResult', `âŒ å¤±è´¥! ${data.error || 'æœªæ‰¾åˆ°API Key'}`, 'error');
                }
            } catch (error) {
                log('envResult', `âŒ é”™è¯¯: ${error.message}\nè¯·ç¡®ä¿ä½¿ç”¨ server_with_env.py å¯åŠ¨æœåŠ¡å™¨`, 'error');
            }
        }

        function testLocalStorageAPIKey() {
            log('localResult', 'æ­£åœ¨æ£€æŸ¥localStorage...', 'info');

            const apiKey = localStorage.getItem('zhipu_api_key');

            if (apiKey) {
                const maskedKey = apiKey.substring(0, 10) + '...' + apiKey.substring(apiKey.length - 4);
                log('localResult', `âœ… æ‰¾åˆ°æœ¬åœ°å­˜å‚¨API Key: ${maskedKey}\næ ¼å¼æ­£ç¡®: ${apiKey.includes('.')}`, 'success');
            } else {
                log('localResult', `âŒ localStorageä¸­æœªæ‰¾åˆ°API Key\nè¯·é€šè¿‡åº”ç”¨ç•Œé¢è¾“å…¥API Key`, 'error');
            }
        }

        async function testGLMAPI() {
            log('apiResult', 'æ­£åœ¨æµ‹è¯•æ™ºè°±AI APIè¿æ¥...\n(è¿™å¯èƒ½éœ€è¦å‡ ç§’é’Ÿ)', 'info');

            let apiKey = null;

            // å…ˆå°è¯•ç¯å¢ƒå˜é‡
            try {
                const response = await fetch('/api/env-api-key');
                const data = await response.json();
                if (data.apiKey) {
                    apiKey = data.apiKey;
                    console.log('ä½¿ç”¨ç¯å¢ƒå˜é‡API Key');
                }
            } catch (error) {
                console.log('æ— æ³•è·å–ç¯å¢ƒå˜é‡API Key');
            }

            // å¦‚æœç¯å¢ƒå˜é‡æ²¡æœ‰,å°è¯•localStorage
            if (!apiKey) {
                apiKey = localStorage.getItem('zhipu_api_key');
                if (apiKey) {
                    console.log('ä½¿ç”¨localStorage API Key');
                }
            }

            if (!apiKey) {
                log('apiResult', 'âŒ æœªæ‰¾åˆ°API Key!\nè¯·å…ˆé…ç½®ç¯å¢ƒå˜é‡æˆ–é€šè¿‡ç•Œé¢è¾“å…¥', 'error');
                return;
            }

            try {
                const startTime = Date.now();

                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey
                    },
                    body: JSON.stringify({
                        model: 'glm-4-flash',
                        messages: [{
                            role: 'user',
                            content: 'è¯·å›ç­”: 1+1=? (åªå›ç­”æ•°å­—)'
                        }],
                        max_tokens: 100
                    })
                });

                const elapsed = Date.now() - startTime;

                if (response.ok) {
                    const data = await response.json();
                    const content = data.content?.[0]?.text || 'æ— æ³•è§£æå“åº”';
                    log('apiResult', `âœ… æˆåŠŸ!\n\nå“åº”æ—¶é—´: ${elapsed}ms\nçŠ¶æ€ç : ${response.status}\n\nAPIè¿”å›:\n${content}`, 'success');
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'æ— æ³•è§£æé”™è¯¯å“åº”' }));
                    log('apiResult', `âŒ APIè¿”å›é”™è¯¯!\n\nçŠ¶æ€ç : ${response.status}\n${response.statusText}\n\né”™è¯¯è¯¦æƒ…:\n${JSON.stringify(errorData, null, 2)}`, 'error');
                }
            } catch (error) {
                log('apiResult', `âŒ è¯·æ±‚å¤±è´¥!\n\né”™è¯¯ç±»å‹: ${error.name}\né”™è¯¯æ¶ˆæ¯: ${error.message}\n\nå¯èƒ½åŸå› :\n1. ç½‘ç»œè¿æ¥é—®é¢˜\n2. CORSè·¨åŸŸé™åˆ¶\n3. APIåœ°å€æ— æ³•è®¿é—®\n\nè¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°è·å–æ›´å¤šä¿¡æ¯`, 'error');
            }
        }

        async function testNetworkConnectivity() {
            log('networkResult', 'æ­£åœ¨æµ‹è¯•ç½‘ç»œè¿æ¥...', 'info');

            const tests = [
                { name: 'æ™ºè°±AI API', url: 'https://open.bigmodel.cn' },
                { name: 'æœ¬åœ°æœåŠ¡å™¨', url: 'http://localhost:8004' },
                { name: 'Chart.js CDN', url: 'https://cdn.jsdelivr.net' }
            ];

            let results = [];

            for (const test of tests) {
                try {
                    const response = await fetch(test.url, { method: 'HEAD', mode: 'no-cors' });
                    results.push(`âœ… ${test.name}: å¯è®¿é—®`);
                } catch (error) {
                    results.push(`âŒ ${test.name}: ${error.message}`);
                }
            }

            log('networkResult', results.join('\n'), results.every(r => r.startsWith('âœ…')) ? 'success' : 'error');
        }

        function showBrowserInfo() {
            const info = {
                'ç”¨æˆ·ä»£ç†': navigator.userAgent,
                'è¯­è¨€': navigator.language,
                'Cookieå¯ç”¨': navigator.cookieEnabled,
                'åœ¨çº¿çŠ¶æ€': navigator.onLine ? 'åœ¨çº¿' : 'ç¦»çº¿',
                'å¹³å°': navigator.platform,
                'JavaScriptç‰ˆæœ¬': 'ES6+',
                'localStorageå¯ç”¨': typeof Storage !== 'undefined',
                'Fetch APIå¯ç”¨': typeof fetch !== 'undefined'
            };

            const text = Object.entries(info)
                .map(([key, value]) => `${key}: ${value}`)
                .join('\n');

            log('browserResult', text, 'info');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œä¸€äº›æµ‹è¯•
        window.onload = function() {
            showBrowserInfo();
            testNetworkConnectivity();
        };
    </script>
</body>
</html>
