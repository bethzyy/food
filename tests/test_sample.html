<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•é¡µé¢ - å…»ç”Ÿé¥®é£Ÿæ¨è</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #7cb342;
        }
        h2 {
            color: #42a5f5;
            margin-top: 0;
        }
        button {
            background: #7cb342;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #689f38;
        }
        .result {
            background: #f9f9f9;
            padding: 15px;
            margin-top: 10px;
            border-radius: 5px;
            border-left: 3px solid #7cb342;
        }
        .error {
            background: #ffebee;
            padding: 15px;
            margin-top: 10px;
            border-radius: 5px;
            border-left: 3px solid #f44336;
        }
        .log-entry {
            background: #fff3e0;
            padding: 10px;
            margin: 5px 0;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª å…»ç”Ÿé¥®é£Ÿæ¨èåº”ç”¨ - æµ‹è¯•é¡µé¢</h1>

    <div class="test-section">
        <h2>1. API Key æµ‹è¯•</h2>
        <p>æµ‹è¯•æ˜¯å¦èƒ½å¤Ÿè·å–å’ŒéªŒè¯API Key</p>
        <button onclick="testApiKey()">æµ‹è¯•API Key</button>
        <div id="apiKeyResult"></div>
    </div>

    <div class="test-section">
        <h2>2. èŠ‚æ°”åˆ¤æ–­æµ‹è¯•</h2>
        <p>æµ‹è¯•ä¸åŒæ—¥æœŸçš„èŠ‚æ°”åˆ¤æ–­åŠŸèƒ½</p>
        <input type="date" id="testDate" value="2024-03-21">
        <button onclick="testSolarTerm()">æµ‹è¯•èŠ‚æ°”</button>
        <div id="solarTermResult"></div>
    </div>

    <div class="test-section">
        <h2>3. å­£èŠ‚ä¸»é¢˜æµ‹è¯•</h2>
        <p>æµ‹è¯•ä¸åŒå­£èŠ‚çš„ä¸»é¢˜åˆ‡æ¢</p>
        <button onclick="testSeason('spring')">æ˜¥å­£ä¸»é¢˜</button>
        <button onclick="testSeason('summer')">å¤å­£ä¸»é¢˜</button>
        <button onclick="testSeason('autumn')">ç§‹å­£ä¸»é¢˜</button>
        <button onclick="testSeason('winter')">å†¬å­£ä¸»é¢˜</button>
        <div id="seasonResult"></div>
    </div>

    <div class="test-section">
        <h2>4. æç¤ºè¯åŠ è½½æµ‹è¯•</h2>
        <p>æµ‹è¯•æç¤ºè¯æ–‡ä»¶åŠ è½½å’Œæ›¿æ¢åŠŸèƒ½</p>
        <button onclick="testPrompt()">æµ‹è¯•æç¤ºè¯</button>
        <div id="promptResult"></div>
    </div>

    <div class="test-section">
        <h2>5. æ—¥å¿—è®°å½•æµ‹è¯•</h2>
        <p>æµ‹è¯•æ—¥å¿—è®°å½•å’Œå¯¼å‡ºåŠŸèƒ½</p>
        <button onclick="testLog()">è®°å½•æµ‹è¯•æ—¥å¿—</button>
        <button onclick="testExportLog()">å¯¼å‡ºæ—¥å¿—</button>
        <button onclick="testClearLog()">æ¸…ç©ºæ—¥å¿—</button>
        <div id="logResult"></div>
    </div>

    <div class="test-section">
        <h2>6. å®Œæ•´æ¨èæµç¨‹æµ‹è¯•</h2>
        <p>æµ‹è¯•å®Œæ•´çš„é¥®é£Ÿæ¨èç”Ÿæˆæµç¨‹</p>
        <button onclick="testFullRecommendation()">æµ‹è¯•å®Œæ•´æµç¨‹</button>
        <div id="fullTestResult"></div>
    </div>

    <div class="test-section">
        <h2>7. æ•°æ®æ ¼å¼å…¼å®¹æ€§æµ‹è¯•</h2>
        <p>æµ‹è¯•æ–°æ—§JSONæ ¼å¼çš„å…¼å®¹æ€§</p>
        <button onclick="testOldFormat()">æµ‹è¯•æ—§æ ¼å¼</button>
        <button onclick="testNewFormat()">æµ‹è¯•æ–°æ ¼å¼</button>
        <div id="formatResult"></div>
    </div>

    <script src="../app.js"></script>
    <script>
        let app;

        // åˆå§‹åŒ–åº”ç”¨
        window.addEventListener('DOMContentLoaded', () => {
            app = new FoodRecommendationApp();
        });

        // æµ‹è¯•API Key
        async function testApiKey() {
            const resultDiv = document.getElementById('apiKeyResult');
            resultDiv.innerHTML = '<p>æ­£åœ¨æµ‹è¯•...</p>';

            try {
                const apiKey = await app.getApiKey();
                if (apiKey) {
                    resultDiv.innerHTML = `
                        <div class="result">
                            <h4>âœ… API Key è·å–æˆåŠŸ</h4>
                            <p>Keyé•¿åº¦: ${apiKey.length} å­—ç¬¦</p>
                            <p>Keyæ ¼å¼: ${apiKey.substring(0, 10)}...</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h4>âŒ æœªæ‰¾åˆ° API Key</h4>
                            <p>è¯·è®¾ç½®ç³»ç»Ÿå˜é‡ ZHIPU_API_KEY æˆ–åœ¨æµè§ˆå™¨ä¸­è¾“å…¥</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>âŒ æµ‹è¯•å¤±è´¥</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // æµ‹è¯•èŠ‚æ°”åˆ¤æ–­
        function testSolarTerm() {
            const dateInput = document.getElementById('testDate').value;
            const resultDiv = document.getElementById('solarTermResult');

            const date = new Date(dateInput);
            const solarTerm = app.getCurrentSolarTerm(date);
            const season = app.getSeason(date);
            const seasonName = app.getSeasonName(season);

            resultDiv.innerHTML = `
                <div class="result">
                    <h4>âœ… èŠ‚æ°”åˆ¤æ–­ç»“æœ</h4>
                    <p><strong>æ—¥æœŸ:</strong> ${dateInput}</p>
                    <p><strong>èŠ‚æ°”/å­£èŠ‚:</strong> ${solarTerm.name}</p>
                    <p><strong>å­£èŠ‚:</strong> ${seasonName} (${season})</p>
                </div>
            `;
        }

        // æµ‹è¯•å­£èŠ‚ä¸»é¢˜
        function testSeason(season) {
            document.body.className = '';
            document.body.classList.add(season);

            const seasonNames = {
                spring: 'æ˜¥å­£',
                summer: 'å¤å­£',
                autumn: 'ç§‹å­£',
                winter: 'å†¬å­£'
            };

            document.getElementById('seasonResult').innerHTML = `
                <div class="result">
                    <h4>âœ… ä¸»é¢˜å·²åˆ‡æ¢</h4>
                    <p>å½“å‰ä¸»é¢˜: ${seasonNames[season]}</p>
                </div>
            `;
        }

        // æµ‹è¯•æç¤ºè¯
        async function testPrompt() {
            const resultDiv = document.getElementById('promptResult');
            resultDiv.innerHTML = '<p>æ­£åœ¨åŠ è½½æç¤ºè¯...</p>';

            try {
                const params = {
                    date: '2024-03-21',
                    time: '08:00',
                    mealPeriod: 'æ—©é¤',
                    dietType: 'æ—¥å¸¸é¥®é£Ÿ',
                    weather: 'æ™´',
                    solarTerm: 'æ˜¥åˆ†',
                    season: 'æ˜¥å­£'
                };

                const prompt = await app.buildPrompt(params);

                resultDiv.innerHTML = `
                    <div class="result">
                        <h4>âœ… æç¤ºè¯ç”ŸæˆæˆåŠŸ</h4>
                        <p><strong>æç¤ºè¯é•¿åº¦:</strong> ${prompt.length} å­—ç¬¦</p>
                        <p><strong>é¢„è§ˆ (å‰200å­—ç¬¦):</strong></p>
                        <pre style="background: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto;">${prompt.substring(0, 200)}...</pre>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>âŒ æç¤ºè¯ç”Ÿæˆå¤±è´¥</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // æµ‹è¯•æ—¥å¿—è®°å½•
        async function testLog() {
            const resultDiv = document.getElementById('logResult');

            await app.logger.log('TEST_EVENT', {
                message: 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ—¥å¿—',
                timestamp: new Date().toISOString()
            });

            const logs = app.logger.getLogs();
            resultDiv.innerHTML = `
                <div class="result">
                    <h4>âœ… æ—¥å¿—è®°å½•æˆåŠŸ</h4>
                    <p>å½“å‰æ—¥å¿—æ•°é‡: ${logs.length}</p>
                </div>
            `;
        }

        // å¯¼å‡ºæ—¥å¿—
        function testExportLog() {
            app.logger.exportLogs();
            document.getElementById('logResult').innerHTML += `
                <div class="result">
                    <h4>âœ… æ—¥å¿—å·²å¯¼å‡º</h4>
                    <p>æ—¥å¿—æ–‡ä»¶å·²ä¸‹è½½</p>
                </div>
            `;
        }

        // æ¸…ç©ºæ—¥å¿—
        function testClearLog() {
            app.logger.clearLogs();
            document.getElementById('logResult').innerHTML = `
                <div class="result">
                    <h4>âœ… æ—¥å¿—å·²æ¸…ç©º</h4>
                </div>
            `;
        }

        // æµ‹è¯•å®Œæ•´æ¨èæµç¨‹
        async function testFullRecommendation() {
            const resultDiv = document.getElementById('fullTestResult');
            resultDiv.innerHTML = '<p>æ­£åœ¨æµ‹è¯•å®Œæ•´æ¨èæµç¨‹...</p>';

            try {
                const recommendation = await app.callGLMAPI({
                    date: '2024-03-21',
                    time: '08:00',
                    mealPeriod: 'æ—©é¤',
                    dietType: 'æ—¥å¸¸é¥®é£Ÿ',
                    weather: 'æ™´',
                    solarTerm: 'æ˜¥åˆ†',
                    season: 'æ˜¥å­£'
                });

                resultDiv.innerHTML = `
                    <div class="result">
                        <h4>âœ… å®Œæ•´æµç¨‹æµ‹è¯•æˆåŠŸ</h4>
                        <p><strong>èœå“æ•°é‡:</strong> ${recommendation.dishes.length}</p>
                        <p><strong>æ€»çƒ­é‡:</strong> ${recommendation.totalNutrition.calories} å¤§å¡</p>
                        <p><strong>ç¬¬ä¸€é“èœ:</strong> ${recommendation.dishes[0].name}</p>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>âŒ å®Œæ•´æµç¨‹æµ‹è¯•å¤±è´¥</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // æµ‹è¯•æ—§æ ¼å¼
        function testOldFormat() {
            const oldFormat = {
                dishes: [
                    {
                        name: 'æµ‹è¯•èœå“',
                        ingredients: ['é£Ÿæ1', 'é£Ÿæ2'],
                        nutrition: 'è¥å…»ä¸°å¯Œ',
                        recipe: ['æ­¥éª¤1', 'æ­¥éª¤2']
                    }
                ],
                totalNutrition: {
                    calories: 500,
                    protein: 30,
                    fat: 20,
                    carbs: 50,
                    vitamins: ['VA', 'VC'],
                    minerals: ['é’™', 'é“'],
                    summary: 'è¥å…»å‡è¡¡'
                }
            };

            app.displayRecommendation(oldFormat);

            document.getElementById('formatResult').innerHTML = `
                <div class="result">
                    <h4>âœ… æ—§æ ¼å¼å…¼å®¹æ€§æµ‹è¯•é€šè¿‡</h4>
                    <p>å·²æˆåŠŸæ¸²æŸ“æ—§æ ¼å¼æ•°æ®</p>
                </div>
            `;
        }

        // æµ‹è¯•æ–°æ ¼å¼
        function testNewFormat() {
            const newFormat = {
                dishes: [
                    {
                        name: 'æ–°æµ‹è¯•èœå“',
                        type: 'ä¸»é£Ÿ',
                        ingredients: [
                            {item: 'å¤§ç±³', amount: '100g', effect: 'è¡¥ä¸­ç›Šæ°”'},
                            {item: 'é¸¡è›‹', amount: '50g', effect: 'æ»‹é˜´æ¶¦ç‡¥'}
                        ],
                        recipe: ['æ­¥éª¤1', 'æ­¥éª¤2', 'æ­¥éª¤3'],
                        nutrition: {
                            calories: 300,
                            protein: 15,
                            fat: 10,
                            carbs: 40,
                            description: 'è¥å…»å‡è¡¡'
                        },
                        suitable: 'é€‚åˆæ‰€æœ‰äººç¾¤'
                    }
                ],
                totalNutrition: {
                    calories: 600,
                    protein: {
                        amount: 35,
                        percentage: 23.3,
                        sources: 'é¸¡è›‹ã€å¤§ç±³'
                    },
                    fat: {
                        amount: 22,
                        percentage: 14.7,
                        sources: 'é¸¡è›‹'
                    },
                    carbs: {
                        amount: 65,
                        percentage: 43.3,
                        sources: 'å¤§ç±³'
                    },
                    vitamins: [
                        {name: 'ç»´ç”Ÿç´ A', amount: '200Î¼g'},
                        {name: 'ç»´ç”Ÿç´ C', amount: '10mg'}
                    ],
                    minerals: [
                        {name: 'é’™', amount: '50mg'},
                        {name: 'é“', amount: '3mg'}
                    ],
                    summary: 'è¥å…»å‡è¡¡ï¼Œç¬¦åˆæ˜¥å­£å…»ç”Ÿç‰¹ç‚¹'
                },
                tips: {
                    shopping: 'é€‰æ‹©æ–°é²œé£Ÿæ',
                    cooking: 'æ³¨æ„ç«å€™',
                    pairing: 'é…ç»¿èŒ¶',
                    taboo: 'æ— ç‰¹æ®Šç¦å¿Œ'
                }
            };

            app.displayRecommendation(newFormat);

            document.getElementById('formatResult').innerHTML = `
                <div class="result">
                    <h4>âœ… æ–°æ ¼å¼å…¼å®¹æ€§æµ‹è¯•é€šè¿‡</h4>
                    <p>å·²æˆåŠŸæ¸²æŸ“æ–°æ ¼å¼æ•°æ®</p>
                </div>
            `;
        }
    </script>
</body>
</html>
