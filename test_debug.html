<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°ƒè¯•æµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #7cb342;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #689f38;
        }
        .log {
            background: #f9f9f9;
            padding: 10px;
            margin: 10px 0;
            border-left: 3px solid #7cb342;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .error {
            border-left-color: #f44336;
            background: #ffebee;
        }
        .success {
            border-left-color: #4caf50;
            background: #e8f5e9;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ å…»ç”Ÿé¥®é£Ÿæ¨è - è°ƒè¯•å·¥å…·</h1>

    <div class="test-section">
        <h2>1. API Key æ£€æŸ¥</h2>
        <button onclick="checkApiKey()">æ£€æŸ¥API Key</button>
        <div id="apiKeyResult"></div>
    </div>

    <div class="test-section">
        <h2>2. èŠ‚æ°”è®¡ç®—æµ‹è¯•</h2>
        <button onclick="testSolarTerm()">æµ‹è¯•èŠ‚æ°”è®¡ç®—</button>
        <div id="solarTermResult"></div>
    </div>

    <div class="test-section">
        <h2>3. APIè¿æ¥æµ‹è¯•</h2>
        <button onclick="testAPIConnection()">æµ‹è¯•GLM APIè¿æ¥</button>
        <div id="apiConnectionResult"></div>
    </div>

    <div class="test-section">
        <h2>4. æç¤ºè¯åŠ è½½æµ‹è¯•</h2>
        <button onclick="testPromptLoading()">æµ‹è¯•æç¤ºè¯åŠ è½½</button>
        <div id="promptResult"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.6.12/lunar.js"></script>
    <script>
        // å·¥å…·å‡½æ•°ï¼šæ˜¾ç¤ºæ—¥å¿—
        function showLog(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const className = type === 'error' ? 'log error' :
                             type === 'success' ? 'log success' : 'log';
            element.innerHTML = `<div class="${className}">${message}</div>`;
        }

        // 1. æ£€æŸ¥API Key
        async function checkApiKey() {
            let logs = [];

            // æ£€æŸ¥localStorage
            const localKey = localStorage.getItem('ZHIPU_API_KEY');
            if (localKey) {
                logs.push(`âœ… localStorageæ‰¾åˆ°API Key: ${localKey.substring(0, 10)}...`);
            } else {
                logs.push(`âŒ localStorageä¸­æœªæ‰¾åˆ°API Key`);
            }

            // æ£€æŸ¥åç«¯API
            try {
                const response = await fetch('/api/env-api-key');
                if (response.ok) {
                    const data = await response.json();
                    if (data.apiKey) {
                        logs.push(`âœ… åç«¯ç¯å¢ƒå˜é‡API Key: ${data.apiKey.substring(0, 10)}...`);
                    } else {
                        logs.push(`âš ï¸ åç«¯è¿”å›ç©ºAPI Key`);
                    }
                } else {
                    logs.push(`âš ï¸ åç«¯APIè¿”å›çŠ¶æ€: ${response.status}`);
                }
            } catch (error) {
                logs.push(`â„¹ï¸ åç«¯APIä¸å¯ç”¨: ${error.message}`);
            }

            showLog('apiKeyResult', logs.join('\n'), localKey ? 'success' : 'error');
        }

        // 2. æµ‹è¯•èŠ‚æ°”è®¡ç®—
        function testSolarTerm() {
            try {
                const logs = [];

                // æµ‹è¯•lunaråº“æ˜¯å¦åŠ è½½
                if (typeof Solar === 'undefined') {
                    logs.push('âŒ lunar-javascriptåº“æœªåŠ è½½');
                    showLog('solarTermResult', logs.join('\n'), 'error');
                    return;
                }
                logs.push('âœ… lunar-javascriptåº“å·²åŠ è½½');

                // æµ‹è¯•å½“å‰æ—¥æœŸçš„èŠ‚æ°”
                const now = new Date();
                logs.push(`æµ‹è¯•æ—¥æœŸ: ${now.toLocaleDateString()}`);

                const solar = Solar.fromDate(now);
                const lunar = solar.getLunar();

                logs.push(`å†œå†: ${lunar.getYearInGanZhi()}å¹´ ${lunar.getMonthInChinese()}æœˆ ${lunar.getDayInChinese()}`);

                // è·å–å‰åèŠ‚æ°”
                const prevJie = lunar.getPrevJie(false);
                const nextJie = lunar.getNextJie(false);

                if (prevJie) {
                    logs.push(`âœ… ä¸Šä¸€ä¸ªèŠ‚æ°”: ${prevJie.getName()}`);
                    logs.push(`   æ—¥æœŸ: ${prevJie.toYmd()}`);
                }

                if (nextJie) {
                    logs.push(`âœ… ä¸‹ä¸€ä¸ªèŠ‚æ°”: ${nextJie.getName()}`);
                    logs.push(`   æ—¥æœŸ: ${nextJie.toYmd()}`);
                }

                showLog('solarTermResult', logs.join('\n'), 'success');
            } catch (error) {
                showLog('solarTermResult', `âŒ é”™è¯¯: ${error.message}\n${error.stack}`, 'error');
            }
        }

        // 3. æµ‹è¯•APIè¿æ¥
        async function testAPIConnection() {
            const logs = [];

            // è·å–API Key
            let apiKey = localStorage.getItem('ZHIPU_API_KEY');
            if (!apiKey) {
                try {
                    const response = await fetch('/api/env-api-key');
                    if (response.ok) {
                        const data = await response.json();
                        apiKey = data.apiKey;
                    }
                } catch (error) {
                    logs.push('âŒ æ— æ³•è·å–API Key');
                    showLog('apiConnectionResult', logs.join('\n'), 'error');
                    return;
                }
            }

            if (!apiKey) {
                logs.push('âŒ API Keyä¸ºç©º');
                showLog('apiConnectionResult', logs.join('\n'), 'error');
                return;
            }

            logs.push(`âœ… API Key: ${apiKey.substring(0, 10)}...`);

            try {
                logs.push('æ­£åœ¨æµ‹è¯•GLM-4-flashæ¨¡å‹...');
                const startTime = Date.now();

                const response = await fetch('https://open.bigmodel.cn/api/anthropic/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey
                    },
                    body: JSON.stringify({
                        model: 'glm-4-flash',
                        max_tokens: 100,
                        messages: [{
                            role: 'user',
                            content: 'è¯·å›å¤"æµ‹è¯•æˆåŠŸ"'
                        }]
                    })
                });

                const elapsed = Date.now() - startTime;
                logs.push(`å“åº”æ—¶é—´: ${elapsed}ms`);

                if (response.ok) {
                    const data = await response.json();
                    logs.push(`âœ… APIè°ƒç”¨æˆåŠŸ!`);
                    logs.push(`è¿”å›å†…å®¹: ${JSON.stringify(data.content[0].text)}`);
                    showLog('apiConnectionResult', logs.join('\n'), 'success');
                } else {
                    const errorText = await response.text();
                    logs.push(`âŒ APIè°ƒç”¨å¤±è´¥: ${response.status}`);
                    logs.push(`é”™è¯¯ä¿¡æ¯: ${errorText}`);
                    showLog('apiConnectionResult', logs.join('\n'), 'error');
                }
            } catch (error) {
                logs.push(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`);
                showLog('apiConnectionResult', logs.join('\n'), 'error');
            }
        }

        // 4. æµ‹è¯•æç¤ºè¯åŠ è½½
        async function testPromptLoading() {
            const logs = [];

            try {
                logs.push('æ­£åœ¨åŠ è½½æç¤ºè¯æ–‡ä»¶...');
                const response = await fetch('prompts/food_recommendation_prompt.txt');

                if (response.ok) {
                    const content = await response.text();
                    logs.push(`âœ… æç¤ºè¯åŠ è½½æˆåŠŸ!`);
                    logs.push(`æ–‡ä»¶å¤§å°: ${content.length} å­—ç¬¦`);
                    logs.push(`å‰100ä¸ªå­—ç¬¦: ${content.substring(0, 100)}...`);
                    showLog('promptResult', logs.join('\n'), 'success');
                } else {
                    logs.push(`âŒ æç¤ºè¯åŠ è½½å¤±è´¥: ${response.status}`);
                    logs.push(`æç¤º: è¯·ç¡®ä¿é€šè¿‡HTTPæœåŠ¡å™¨è®¿é—®æ­¤é¡µé¢`);
                    showLog('promptResult', logs.join('\n'), 'error');
                }
            } catch (error) {
                logs.push(`âŒ åŠ è½½å¤±è´¥: ${error.message}`);
                logs.push(`æç¤º: è¯·ç¡®ä¿é€šè¿‡HTTPæœåŠ¡å™¨è®¿é—®æ­¤é¡µé¢ï¼Œä¸è¦ç›´æ¥æ‰“å¼€HTMLæ–‡ä»¶`);
                showLog('promptResult', logs.join('\n'), 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œæ£€æŸ¥
        window.onload = function() {
            console.log('=== è°ƒè¯•é¡µé¢åŠ è½½å®Œæˆ ===');
            console.log('å½“å‰URL:', window.location.href);

            if (window.location.protocol === 'file:') {
                alert('âš ï¸ è­¦å‘Š: æ‚¨ç›´æ¥æ‰“å¼€äº†HTMLæ–‡ä»¶!\n\nè¯·é€šè¿‡HTTPæœåŠ¡å™¨è®¿é—®:\n1. cd C:\\D\\CAIE_tool\\MyAIProduct\\food\n2. python -m http.server 8000\n3. è®¿é—® http://localhost:8000/test_debug.html');
            }
        };
    </script>
</body>
</html>
