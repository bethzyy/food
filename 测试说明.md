# 环境变量测试说明

## 问题分析

从您的错误信息看到：
1. 启动了 `start_server.py`（不支持环境变量）
2. 前端请求 `/api/env-api-key` 返回 404

## 解决方案

### 步骤1：测试环境变量是否设置成功

**运行测试服务器：**
```bash
python test_env_key.py
```

或者双击：`测试环境变量.bat`

然后访问：http://localhost:8001/test_env.html

**检查点：**
- ✅ 是否显示环境变量已设置
- ✅ API Key长度是否正确
- ✅ 前端能否成功请求到 `/api/env-api-key`

### 步骤2：正确启动主应用

**方法A：使用启动脚本（推荐）**
```bash
双击：启动.bat
```

脚本会自动检测环境变量并选择正确的服务器：
- 有环境变量 → 使用 `server_with_env.py`（支持环境变量）
- 无环境变量 → 使用 `start_server.py`（手动输入）

**方法B：手动启动**
```bash
# 如果已设置环境变量
python server_with_env.py

# 如果未设置环境变量
python start_server.py
```

### 步骤3：验证

打开浏览器控制台（F12），查看日志：
- ✅ 成功：`✅ 从环境变量成功读取API Key`
- ❌ 失败：`ℹ️ 后端API不可用，尝试其他方式`

## 环境变量设置方法

### Windows PowerShell
```bash
$env:ZHIPU_API_KEY="你的API Key"
```

### Windows CMD
```bash
set ZHIPU_API_KEY=你的API Key
```

**注意：**
- 环境变量只在当前命令行窗口有效
- 设置后需要在该窗口中启动应用
- 关闭窗口后环境变量失效

### 永久设置（可选）

**Windows：**
1. 右键"此电脑" → 属性
2. 高级系统设置 → 环境变量
3. 在"用户变量"中新建：
   - 变量名：`ZHIPU_API_KEY`
   - 变量值：你的API Key

## 常见问题

### Q: 为什么总是读取不到环境变量？
A: 检查以下几点：
1. 是否在正确的命令行窗口设置的环境变量
2. 设置环境变量后是否在同一窗口启动应用
3. 是否使用了正确的服务器（`server_with_env.py`）

### Q: start_server.py 和 server_with_env.py 有什么区别？
A:
- `start_server.py` - 简单服务器，不支持环境变量API
- `server_with_env.py` - 支持环境变量API，提供 `/api/env-api-key` 接口

### Q: 启动.bat 是如何工作的？
A:
1. 检查环境变量是否存在
2. 如果存在，启动 `server_with_env.py`
3. 如果不存在，启动 `start_server.py`

## 测试流程

**完整测试流程：**

1. **设置环境变量**
   ```bash
   $env:ZHIPU_API_KEY="1234.abc123def456"
   ```

2. **测试环境变量**
   ```bash
   python test_env_key.py
   ```
   访问 http://localhost:8001/test_env.html

3. **启动主应用**
   ```bash
   python server_with_env.py
   ```
   或双击 `启动.bat`

4. **验证**
   - 打开浏览器控制台
   - 点击"生成饮食推荐"
   - 查看日志：应该显示 `✅ 从环境变量成功读取API Key`

## 快速检查清单

- [ ] 已设置环境变量 `ZHIPU_API_KEY`
- [ ] 使用正确的服务器 `server_with_env.py`
- [ ] 或使用启动脚本 `启动.bat`
- [ ] 测试服务器能正确返回API Key
- [ ] 浏览器控制台显示成功读取

---

**重要提示：**
环境变量只在当前命令行窗口有效！每次重新打开命令行窗口都需要重新设置。
